syntax = "proto3";

package bank.account;

import "common.proto";

option java_multiple_files = true;
option java_package = "com.banking.proto.account";

service AccountService {
  rpc GetBalance(GetBalanceRequest) returns (GetBalanceResponse);

  // Step 1: Prevent double-spend (debit source)
  rpc ReserveBalance(ReserveBalanceRequest) returns (ReserveBalanceResponse);

  // Step 2: Credit destination account
  rpc CreditBalance(CreditBalanceRequest) returns (CreditBalanceResponse);

  // Step 3: Permanently deduct money from source
  rpc CommitReservation(CommitReservationRequest) returns (CommitReservationResponse);

  // Rollback path (timeouts, failures)
  rpc ReleaseReservation(ReleaseReservationRequest) returns (ReleaseReservationResponse);
}

message GetBalanceRequest {
  string account_id = 1; // âœ… Rule 3: IDs are strings Even if DB uses UUID/Long.
}

message GetBalanceResponse {
  bank.common.Money available_balance = 1;
}

message ReserveBalanceRequest {
  string account_id = 1;
  bank.common.Money amount = 2;

  // Idempotency key generated by payment-service (idempotency -> prevents double reservation)
  string idempotency_key = 3;
}

message ReserveBalanceResponse {
  string reservation_id = 1;
//  bool success = 1;
//  bank.common.ErrorResponse error = 2;
}

message CommitReservationRequest {
  string reservation_id = 1;
  string transaction_id = 2;
}

message CommitReservationResponse {
}

message ReleaseReservationRequest {
  string reservation_id = 1;
  string reason = 2; // optional, for audit/debug
}

message ReleaseReservationResponse {
}

// ==================== Credit Balance Messages ====================

message CreditBalanceRequest {
  string account_id = 1;        // Destination account to credit
  bank.common.Money amount = 2; // Amount to add
  string reference_id = 3;      // Reference for audit (e.g., reservation_id or transaction_id)
  string description = 4;       // Optional description
}

message CreditBalanceResponse {
  bank.common.Money new_balance = 1; // New balance after credit
}